---
title: CRUD z JSON
---

# CRUD z JSON
Na razie restart serwera przywracał pierwotne dane,
bo wcale nie modyfikowaliśmy pliku `gamesData.ts`.

Teraz będziemy modyfikowali plik `gamesData.json`.

## Zamiana `gamesData.ts` na plik `gamesData.json`.
```json
[
    { "id": 1, "title": "Super Mario Bros.", "year": 1985, "platform": "NES", "genre": "Platform" },
    { "id": 2, "title": "Pong", "year": 1972, "platform": "Arcade", "genre": "Sport" },
    { "id": 3, "title": "Boulder Dash", "year": 1984, "platform": "Atari 800XL", "genre": "Action" },
    { "id": 4, "title": "River Raid", "year": 1982, "platform": "Atari 800XL", "genre": "Shooter" },
    { "id": 5, "title": "Asteroids", "year": 1979, "platform": "Arcade", "genre": "Shooter" },
    { "id": 6, "title": "Space Invaders", "year": 1978, "platform": "Arcade", "genre": "Shooter" },
    { "id": 7, "title": "Sabre Wulf", "year": 1984, "platform": "ZX Spectrum", "genre": "Adventure" },
    { "id": 8, "title": "Impossible Mission", "year": 1984, "platform": "Commodore 64", "genre": "Adventure" }
]

```


## Definicja funkcji pomocniczych
W naszym projekcie zastosujemy zasadę *seperation of concerns*:
- potrzebujemy modułów: `fs` i `path`,
- zdefiniujemy pomocnicze funkcje (`utils/fileUtiles.ts`):
  - `readJSON` ,
  - `writeJSON`,
- utwórzymy nowy folder `src/utlis`
- wewnątrz tego folderu utwórzymy plik `fileUtils.ts`

```ts
import fs from "fs"
import path from "path"


export function readJSON(fileName: string): any[] {
    const filePath = path.join(__dirname, "..", "data", fileName)
    const data = fs.readFileSync(filePath, "utf-8");
    return JSON.parse(data);
}

export function writeJSON(fileName: string, data:any[]): void {
    const filePath = path.join(__dirname, "..", "data", fileName)
    fs.writeFileSync(filePath, JSON.stringify(data, null, 2), "utf-8");
}
```

## `GET` - refaktoryzacja kodu w `routes/games.ts`
Zakomentujmy wszystkie `route.`

### Refactoryzacja `GET /games`
Plik `routes/games.ts` bez części zakomentowanej, ale z nowym kodem:
```ts
import express, {Request, Response} from "express";
import{ readJSON, writeJSON } from "../utils/fileUtils";

const router = express.Router();
const fileName = "gamesData.json";


router.get("/", (req: Request, res: Response) => {
    const games = readJSON(fileName)
    const {year, platform} = req.query;
    console.log(year, platform)

    if(!year && !platform) return res.json(games)

    const filteredGames = games.filter(g => {
        if (year && g.year > Number(year))  return false

        if(platform){
            if (typeof platform === "string"){
                const queryPlatform = platform.toLowerCase();
                const gamePlatform = g.platform.toLowerCase();
                if(!gamePlatform.includes(queryPlatform)) return false;
            }
        }
        return true
    });
    res.json(filteredGames);
});

//...


export default router;
```
Sprawdź, czy `request` `GET http://localhost:3000/games` zwróci listę gier, bo powinien.

### Refactoryzacja `GET /games/3`
Pod poprzednią metodą dopisujemy:
```ts
router.get("/:id", (req: Request, res: Response) => {
    const games = readJSON(fileName)
    const id = Number(req.params.id);
    const game = games.find(g => g.id === Number(req.params.id));
    if (!game) return res.status(404).json({ message: "Game not found" });
    res.json(game);
});

```
Sprawdzamy, żę faktycznie działa.



## Refaktoryzacja `POST /games`
```ts
router.post("/", (req: Request, res: Response) => {
    console.log(req.body) // w konsoli podglądamy wartość po działąniu express.json()
    try{
        // POBIERAMY DANE Z "BAZY" json
        const games: Game[] = readJSON(fileName);

        const newGame: Game = {
            id: Date.now(),
            ...req.body
        };

        games.push(newGame); // dodajemy do naszej listy jakby bazy danych

        // ZAPISUJEMY DANE W "BAZIE" json
        writeJSON(fileName, games);

        res.status(201).json(newGame); // zwracamy nowy obiekt z kodem 201
    }catch(error){
        if(error instanceof Error){
            res.status(500).json({message: error.message});
        }else{
            console.error(error);
        }
    }
})
```

Sprawdzamy wbudowanym klientem, czy faktycznie nowy zasób zostanie zapisany do pliku `gamesData.json`.

## Refaktoryzacja `PUT` i `PATCH`
```ts

router.put("/:id", (req, res) => {
    try {
        const id = Number(req.params.id); // parsowanie id: string -> id: int
        const games: Game[] = readJSON(fileName);

        const index = games.findIndex(g => g.id === id); // zwraca index albo -1
        if (index === -1) return res.status(404).json({message: "Game not found"});

        games[index] = {id, ...req.body};
        writeJSON(fileName, games);

        res.json(games[index]);
    } catch (error) {
        console.error("Error updating the game", error); // Log do konsoli
        res.status(500).json({ message: "Internal server error" }); // Odpowiedź dla klienta
    }
});

router.patch("/:id", (req, res) => {
    try{
        const id = Number(req.params.id);
        const games: Game[] = readJSON(fileName);
        const game = games.find(g => g.id === id);
        if (!game) return res.status(404).send("Game not found");

        Object.assign(game, req.body); // aktualizacja tylko podanych pól
        // ZAPIS DO "BAZY" json
        writeJSON(fileName, games);

        res.json(game);
    }catch(error){
        console.error(error)
    }
});

```
Sprawdzamy, czy działa.

## Reafaktoryzacja `DELETE`
```ts

router.delete("/:id", (req: Request, res: Response) => {
    try {
        const id = Number(req.params.id);
        const games: Game[] = readJSON(fileName);

        // Walidacja ID
        if (isNaN(id) || id <= 0) {
            return res.status(400).json({ message: "Invalid ID value — please provide a positive integer." });
        }

        const index = games.findIndex(g => g.id === id);
        if (index === -1) {
            return res.status(404).json({ message: "Game not found" });
        }

        // Usuń grę
        const deletedGame = games.splice(index, 1)[0];
        writeJSON(fileName, games);

        res.json({
            message: "Game deleted successfully!",
            deleted: deletedGame
        });
    } catch (error) {
        console.error("Error deleting the game: ", error);
        res.status(500).json({ message: "Internal server error" });
    }
});
```

























