---
title: MiddleWare
---

# Co to jest MiddleWare?

## Definicja
:::info Middleware
To po prostu funkcja poÅ›redniczÄ…c:
- czyli kawaÅ‚ek kodu, ktÃ³ry przechwytuje kaÅ¼de Å¼Ä…danie (`request`)
- zanim trafi ono do wÅ‚aÅ›ciwego endpointu (`app.get`, `app.post` itd.),
- lub przechwytuje odpowiedÅº (response) zanim opuÅ›ci serwer.

MoÅ¼esz o nim myÅ›leÄ‡ jako o filtrze lub etapie po drodze miÄ™dzy klientem a serwerem.

:::


## Metafory
:::tip Middleware jako filtry w kawiarni
Middleware dziaÅ‚a jak filtry przy parzeniu kawy:
- gorÄ…ca woda (request) przechodzi przez filtr po filtrze (kolejne middlewareâ€™y),
- kaÅ¼dy coÅ› zmienia (np. odfiltrowuje fusy, dodaje aromat, mleko, cukier),
- efekt koÅ„cowy to gotowy napÃ³j (response).

JeÅ›li ktÃ³ryÅ› filtr siÄ™ zatka â€” kawa nie dotrze do kubka â˜•
(to jak brak next() â†’ Å¼Ä…danie siÄ™ zatrzymuje).

:::

:::tip ðŸ§³ Middleware â€” metafora lotniska
WyobraÅº sobie, Å¼e:
- **Å¼Ä…danie (request)** to pasaÅ¼er, ktÃ³ry chce dostaÄ‡ siÄ™ do samolotu âœˆï¸
- Zanim jednak tam trafi, musi przejÅ›Ä‡ przez kilka **kontroli** â€” to wÅ‚aÅ›nie *middlewareâ€™y* w Expressie.

KaÅ¼dy middleware:
- moÅ¼e coÅ› **sprawdziÄ‡** (np. czy masz paszport â†’ autoryzacja),
- moÅ¼e coÅ› **dodaÄ‡** (np. dane z JSON-a â†’ `req.body`),
- moÅ¼e **zatrzymaÄ‡ CiÄ™** (np. bÅ‚Ä…d 401),
- albo przepuÅ›ciÄ‡ dalej (`next()`).

JeÅ›li middleware nie wywoÅ‚a `next()`:
- pasaÅ¼er zostaje zatrzymany i
- nie dociera do samolotu.

:::

## Syntaktyka Middleware`a
WzÃ³r funkcji Middleware:
```
(req, res, next) => {
// coÅ› robimy z Å¼Ä…daniem lub odpowiedziÄ…
next(); // przekazuje sterowanie do kolejnego middlewareâ€™a lub endpointu
}

```


## PrzykÅ‚ad

### Middleware dla zapytania pod dowolnÄ… Å›cieÅ¼kÄ…

:::tip `app.use()`
- dodaje middleware,
- bez dookreÅ›lenia Å›cieÅ¼ki dziaÅ‚a dla wszystkich zapytaÅ„.

:::


Do naszego pliku `app.ts` dopiszemy pierwszy middleware:
```ts
//...
const app = express();

// TO JEST MIDDLEWARE !!!
app.use((req, res, next) => {
    console.log(`${req.method} ${req.url}`);
    next(); // przejdÅº dalej
});
//...

```

### Middleware tylko dla Å›cieÅ¼ek `/house`
Do naszego pliku `app.ts` dopiszemy drugi middleware:
```ts
//...
const app = express();
//..

// Middleware aktywny TYLKO dla Å›cieÅ¼ek zaczynajÄ…cych siÄ™ od /house
app.use("/house", (req, res, next) => {
    console.log("Middleware uruchomiony dla /house");
    next(); // przepuÅ›Ä‡ dalej do wÅ‚aÅ›ciwego endpointu
});


// Dopiszemy kilka Å›cieÅ¼ek
// ðŸ”¹ przykÅ‚adowe endpointy
app.get("/house", (req, res) => {
    res.send("Witaj w domu!");
});

app.get("/house/room", (req, res) => {
    res.send("To jest pokÃ³j w domu ðŸ›ï¸");
});

app.get("/garden", (req, res) => {
    res.send("Tu nie dziaÅ‚a middleware ðŸª´");
});
//...

```

Dopiszymy do naszego klienta `.http` kilka testowych zapytaÅ„
```http request
@baseUrl = http://localhost:3000/

### pelne zapytanie
GET http://localhost:3000
Accept: application/json

### zapytanie skrÃ³cone
GET {{baseUrl}}
Accept: application/json

# NOWE ZAPYTANIA

### zapytanie pod house
GET {{baseUrl}}/house
Accept: application/json

### zapytanie pod house
GET {{baseUrl}}/house/room
Accept: application/json

### zapytanie pod garden bez middleware
GET {{baseUrl}}/graden
Accept: application/json

```

---
PrzywrÃ³Ä‡my stan `app.ts` i `.http` do poprzedniego stanu.


---
## `app.use(express.json())

:::info Co robi  `app.use(express.json())`
To middleware (czyli funkcja poÅ›redniczÄ…ca), ktÃ³ry mÃ³wi Expressowi:
    â€žJeÅ›li klient wysyÅ‚a dane w formacie JSON,
        - odczytaj je,
        - przetwÃ³rz i
        - zapisz w `req.body` jako obiekt JavaScript.â€

:::

ZaÅ‚Ã³Å¼my, Å¼e klient wysyÅ‚a Å¼Ä…danie (`request`):
```http request
POST /games
Content-Type: application/json

{
  "title": "Doom",
  "year": 1993,
  "platform": "PC"
}
```
- Å»Ä…danie jest przechwytywane przez middleware `express.json()`.
- Express:
    - czyta surowe dane JSON z Å¼Ä…dania,
    - parsuje (konwertuje) je do obiektu JS,
    - udostÄ™pnia je w `req.body`, wiÄ™c moÅ¼esz ich uÅ¼ywaÄ‡ w kodzie.
- czyli w kodzie moÅ¼emy odczytaÄ‡ np. tytuÅ‚ tego obiektu:
```ts
app.post("/games", (req, res) => {
  console.log(req.body.title); // ðŸ‘‰ "Doom"
  res.send(`Dodano grÄ™: ${req.body.title}`);
});
```

Dodajmy ten middleware do naszego pliku `app.ts`
```ts
//...

const app = express();

app.use(express.json());

app.get("/", (req, res) => {
    res.send("RetroGames APU. Use/games to see the games");
})
//...
```



