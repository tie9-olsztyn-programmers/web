---
title: Agregacja
---

# Agregacja

## Teoria
### Definicja
:::info Co to jest agregacja?
- Agregacja to sposób przetwarzania danych w etapach (*pipeline*).
- Każdy etap bierze dane z poprzedniego i zmienia je lub filtruje.

:::tip W MongoDB każdy taki etap to operator zaczynający się od $:
- `$match` – wybiera dokumenty
- `$project` – wybiera pola / tworzy nowe pola
- `$group` – grupuje i liczy
- `$sort` – sortuje
- `$limit` – ogranicza wynik
- `$count` – liczy dokumenty
- `$lookup` – dołącza dane z innej kolekcji (prawie jak JOIN)


:::


### Struktura agregacji
```
db.collection.aggregate([
  { etap1 },
  { etap2 },
  { etap3 }
])
```

### Prosty przykład
```
db.users.aggregate([
  { $match: { age: { $gt: 18 } } },
  { $project: { name: 1, age: 1 } }
])
```
- `$match`      wybierz pełnoletnich
- `$project`    pokaż tylko imię i wiek

### `find()` i `aggregate()`
| find() | aggregate() |
|--------|-------------|
| Filtruje dokumenty | Filtruje i przetwarza dokumenty w etapach |
| Pokaż wybrane pola | Twórz nowe pola, zmieniaj strukturę |
| Tylko proste zapytania | Statystyki, grupowanie, sortowanie |
| Nie robi JOIN | Ma `$lookup` |
| Bardzo proste | Bardzo potężne |

## Praktyka
- tworzymy bazę `use foodDB`
- tworzymy kolekcję `db.createCollection("foods")`
- wprowadzamy dane przez interfejs *Compass* -> `Documents` > `+`:
```
/**
* Paste one or more documents here
*/
[
  { "name": "Apple",      "category": "fruit",  "calories": 52,  "vitamins": ["A", "C"] },
  { "name": "Banana",     "category": "fruit",  "calories": 96,  "vitamins": ["B6", "C"] },
  { "name": "Carrot",     "category": "vegetable", "calories": 41, "vitamins": ["A", "K"] },
  { "name": "Broccoli",   "category": "vegetable", "calories": 55, "vitamins": ["C", "K"] },
  { "name": "Chicken",    "category": "meat",   "calories": 239, "vitamins": ["B6"] }
]
```
### Zapytania
#### Wybierzmy tylko warzywa
```
db.foods.aggregate([
  {$match: { category: "vegetable"}}
])
```
#### Z warzyw wyświetlmy tylko nazwę i kaloryczność
```
db.foods.aggregate([
  {$match: { category: "vegetable"}},
  {$project: {name: 1, calories: 1, _id:0}}
])
```


To samo w *Compass*:
- wybieramy zakładkę `Aggregations`:
    - tworzymy nowy `stage` przez naciśnięcie przyciku `Add stage`
    - w `Stage 1 <Select> ` wybieramy `$match` i wpisujemy:
        - `{category: "vegetable"}`
    - w `Stage 2 <Select> ` wybieramy `$project` i wpisujemy:
        - `{ name:1, calories: 1, _id:0 }`



### Grupujemy `$group`

#### Ile produków w danej kategorii
```
db.foods.aggregate([{
 $group: {
  	_id: "$category",
    totalFoods: {$sum: 1}
 }
}])
```
- `_id`     pole, po którym grupujemy (tu: kategoria jedzenia)
- `$sum: 1` dodaj 1 dla każdego dokumentu

:::tip Co to jest `$category`
- `"$category"` oznacza: „weź wartość pola `category` z każdego dokumentu”
- Czyli:
    - bez `$` to zwykły tekst "category"
    - z `$` to odwołanie do pola w dokumencie


to tak, jabyśmy powiedzieli:
„Grupuj dokumenty według tego, co jest zapisane w polu category”.

:::



#### Średnia liczba kalorii w każdej kategorii
```
db.foods.aggregate([
  {
    $group: {
      _id: "$category",
      avgCalories: { $avg: "$calories" }
    }
  }
])
```


#### Najmniej i najbardziej kaloryczny produkt w kategorii
```
db.foods.aggregate([
  {
    $group: {
      _id: "$category",
      minCalories: { $min: "$calories" },
      maxCalories: { $max: "$calories" }
    }
  }
])
```


#### Lista nazw produktów w każdej kategorii
```
db.foods.aggregate([
  {
    $group: {
      _id: "$category",
      products: { $push: "$name" }
        }
    }
])
```



### Sortujemy
#### Sortowanie po kaloriach malejąco (najbardziej kaloryczne)
```
db.foods.aggregate([
  { $sort: { calories: -1 } }
])
```

:::tip sortowanie `1`, `-1`
- sortowanie w agregacji,
- `-1` = malejąco, `1 =` rosnąco.

:::




#### Sortowanie po kategorii, a w ramach kategorii po kaloriach
```
db.foods.aggregate([
  { $sort: { category: 1, calories: -1 } }
])
```

#### Dwa najbardziej kaloryczne produkty
```
db.foods.aggregate([
  { $sort: { calories: -1 } },
  { $limit: 2 }
])

```

### Ograniczenia wyników - `limit`

#### Najbardziej kaloryczny produkt w każdej kategorii

```
db.foods.aggregate([
  { $sort: { calories: -1 } },
  {
    $group: {
      _id: "$category",
      topFood: { $first: "$$ROOT" }
    }
  },
  { $limit: 3 }
])
```


:::tip Co się dzieje krok po kroku?
- `$sort`   dokumenty są posortowane od najbardziej kalorycznych
- `$group`  MongoDB bierze dokumenty kategoria po kategorii
- `$first`  bierze pierwszy dokument w danej grupie
- `$$ROOT`  zapisuje cały dokument, a nie tylko jedno pole


Efekt:
Dla każdej kategorii dostajesz najbardziej kaloryczny produkt jako pełny obiekt.


:::

Takie same zapytanie, ale w odpowiedzie dostajemy tylko nazwę produktu
```
db.foods.aggregate([
    { $sort: { calories: -1 } },
    {
        $group: {
            _id: "$category",
            topFood: { $first: "$name" }
        }
    },
    { $limit: 3 }
])

```

#### Pierwsze 3 produkty po alfabecie (projekcja + limit)
```
db.foods.aggregate([
  { $sort: { name: 1 } },
  { $limit: 3 },
  {
    $project: {
      _id: 0,
      name: 1,
      category: 1
    }
  }
])

```





:::tip
- `$name`   „weź tylko imię”
- `$$ROOT`  „zrób ksero całego dokumentu”

:::


## Zliczanie dokumentów
### Zliczanie podstawowe
Policzenie wszystkich:
`db.users.countDocuments()`

Policzenie z filtrem:
`db.users.countDocuments({ age: { $gt: 18 } })`

### Zliczanie w agregacji
Wracamy do naszej bazy danych z jedzeniem.

#### Zliczamy wszystkie dokumenty
```
db.foods.aggregate([
  { $count: "totalProducts" }
])
```

#### Zliczanie dokumentów w kategoriach
```
db.foods.aggregate([
  {
    $group: {
      _id: "$category",
      count: { $sum: 1 }
    }
  }
])
```
#### Zliczanie tylko owoców i warzyw
```
db.foods.aggregate([
  { $match: { category: { $in: ["fruit", "vegetable"] } } },
  {
    $group: {
      _id: "$category",
      count: { $sum: 1 }
    }
  }
])
```

#### Ile produktów ma dokładnie 2 witaminy?
```
db.foods.aggregate([
  {
    $project: {
      name: 1,
      vitaminsCount: { $size: "$vitamins" }
    }
  },
  { $match: { vitaminsCount: 2 } },
  { $count: "productsWithTwoVitamins" }
])
```

#### Średnia liczba witamin na produkt
```
db.foods.aggregate([
  {
    $project: {
      vitaminsCount: { $size: "$vitamins" }
    }
  },
  {
    $group: {
      _id: null,
      avgVitamins: { $avg: "$vitaminsCount" }
    }
  }
])
```
:::tip `_id` w `$group`
- `_id` określa „po czym dzielimy dokumenty na grupy”
- jeżeli `_id:null`  oznacza „Nie dziel dokumentów na grupy – wrzuć wszystkie do jednej”

:::









## Wracamy do bazy danych z kreskówkami
- pobieramy dokument *Shrek*a
- chcemy wyświetlić imię *Shrek*
- chcemy wyświetlć przyjaciela Shreka
```
db.chartoonCharacters.aggregate([
  { $match: { name: "Shrek" } },
  {
    $project: {
      _id: 0,
      name: 1,
      friend: { $arrayElemAt: ["$friends", 0] }
    }
  }
])
```

:::tip
- `$slice`          ogranicza liczbę elementów tablicy
- `$arrayElemAt`    wyciąga konkretny element tablicy
- `find()`          zwraca dane „jak są”
- `aggregate()`     pozwala zmieniać strukturę wyniku

:::


# ĆWICZENIA

## Przygotowanie bazy i danych
- baza danych: `star_trekDB`
- kolekcja `characters`
- wprowadź dane
```
[
  {
    "name": "Jean-Luc Picard",
    "species": "Human",
    "rank": "Captain",
    "ship": "USS Enterprise-D",
    "series": "TNG",
    "episodes": 178,
    "age": 59,
    "skills": ["diplomacy", "leadership"]
  },
  {
    "name": "William Riker",
    "species": "Human",
    "rank": "Commander",
    "ship": "USS Enterprise-D",
    "series": "TNG",
    "episodes": 176,
    "age": 35,
    "skills": ["tactics", "leadership"]
  },
  {
    "name": "Spock",
    "species": "Vulcan",
    "rank": "Commander",
    "ship": "USS Enterprise",
    "series": "TOS",
    "episodes": 79,
    "age": 66,
    "skills": ["logic", "science"]
  },
  {
    "name": "Kathryn Janeway",
    "species": "Human",
    "rank": "Captain",
    "ship": "USS Voyager",
    "series": "VOY",
    "episodes": 172,
    "age": 42,
    "skills": ["science", "leadership"]
  },
  {
    "name": "Data",
    "species": "Android",
    "rank": "Lieutenant Commander",
    "ship": "USS Enterprise-D",
    "series": "TNG",
    "episodes": 176,
    "age": null,
    "skills": ["science", "analysis"]
  },
  {
    "name": "Worf",
    "species": "Klingon",
    "rank": "Lieutenant",
    "ship": "USS Enterprise-D",
    "series": "TNG",
    "episodes": 172,
    "age": 40,
    "skills": ["combat", "tactics"]
  }
]
```


## Pytania do bazy

1. Ilu bohaterów pochodzi z każdej serii?
2. Jaka jest średnia liczba odcinków na serię?
3. Który bohater wystąpił w największej liczbie odcinków?
4. Ilu kapitanów jest w bazie i jacy to są?
5. Średni wiek bohaterów według gatunku (pomijając androidy)
6. Ile postaci służyło na każdym statku?
7. Jakie umiejętności występują najczęściej?
8. Które serie mają bohaterów z więcej niż 150 odcinkami?
9. Najstarszy bohater w każdej serii
10. Średnia liczba umiejętności na bohatera








