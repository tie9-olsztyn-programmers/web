"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[8243],{3336:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>c,contentTitle:()=>l,default:()=>j,frontMatter:()=>d,metadata:()=>r,toc:()=>t});const r=JSON.parse('{"id":"MongoDB/Agregacja","title":"Agregacja","description":"Teoria","source":"@site/docs/4. MongoDB/60.Agregacja.mdx","sourceDirName":"4. MongoDB","slug":"/MongoDB/Agregacja","permalink":"/web/docs/MongoDB/Agregacja","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/4. MongoDB/60.Agregacja.mdx","tags":[],"version":"current","sidebarPosition":60,"frontMatter":{"title":"Agregacja"},"sidebar":"tutorialSidebar","previous":{"title":"Projekcja","permalink":"/web/docs/MongoDB/ProjekcjaIFiltrowanie"},"next":{"title":"Wprowadzenie do MERN","permalink":"/web/docs/MERN - Fullstack/Intro MERN"}}');var a=n(4848),o=n(8453);const d={title:"Agregacja"},l="Agregacja",c={},t=[{value:"Teoria",id:"teoria",level:2},{value:"Definicja",id:"definicja",level:3},{value:"Struktura agregacji",id:"struktura-agregacji",level:3},{value:"Prosty przyk\u0142ad",id:"prosty-przyk\u0142ad",level:3},{value:"<code>find()</code> i <code>aggregate()</code>",id:"find-i-aggregate",level:3},{value:"Praktyka",id:"praktyka",level:2},{value:"Zapytania",id:"zapytania",level:3},{value:"Wybierzmy tylko warzywa",id:"wybierzmy-tylko-warzywa",level:4},{value:"Z warzyw wy\u015bwietlmy tylko nazw\u0119 i kaloryczno\u015b\u0107",id:"z-warzyw-wy\u015bwietlmy-tylko-nazw\u0119-i-kaloryczno\u015b\u0107",level:4},{value:"Grupujemy <code>$group</code>",id:"grupujemy-group",level:3},{value:"Ile produk\xf3w w danej kategorii",id:"ile-produk\xf3w-w-danej-kategorii",level:4},{value:"\u015arednia liczba kalorii w ka\u017cdej kategorii",id:"\u015brednia-liczba-kalorii-w-ka\u017cdej-kategorii",level:4},{value:"Najmniej i najbardziej kaloryczny produkt w kategorii",id:"najmniej-i-najbardziej-kaloryczny-produkt-w-kategorii",level:4},{value:"Lista nazw produkt\xf3w w ka\u017cdej kategorii",id:"lista-nazw-produkt\xf3w-w-ka\u017cdej-kategorii",level:4},{value:"Sortujemy",id:"sortujemy",level:3},{value:"Sortowanie po kaloriach malej\u0105co (najbardziej kaloryczne)",id:"sortowanie-po-kaloriach-malej\u0105co-najbardziej-kaloryczne",level:4},{value:"Sortowanie po kategorii, a w ramach kategorii po kaloriach",id:"sortowanie-po-kategorii-a-w-ramach-kategorii-po-kaloriach",level:4},{value:"Dwa najbardziej kaloryczne produkty",id:"dwa-najbardziej-kaloryczne-produkty",level:4},{value:"Ograniczenia wynik\xf3w - <code>limit</code>",id:"ograniczenia-wynik\xf3w---limit",level:3},{value:"Najbardziej kaloryczny produkt w ka\u017cdej kategorii",id:"najbardziej-kaloryczny-produkt-w-ka\u017cdej-kategorii",level:4},{value:"Pierwsze 3 produkty po alfabecie (projekcja + limit)",id:"pierwsze-3-produkty-po-alfabecie-projekcja--limit",level:4},{value:"Zliczanie dokument\xf3w",id:"zliczanie-dokument\xf3w",level:2}];function s(e){const i={admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(i.header,{children:(0,a.jsx)(i.h1,{id:"agregacja",children:"Agregacja"})}),"\n",(0,a.jsx)(i.h2,{id:"teoria",children:"Teoria"}),"\n",(0,a.jsx)(i.h3,{id:"definicja",children:"Definicja"}),"\n",(0,a.jsxs)(i.admonition,{title:"Co to jest agregacja?",type:"info",children:[(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:["Agregacja to spos\xf3b przetwarzania danych w etapach (",(0,a.jsx)(i.em,{children:"pipeline"}),")."]}),"\n",(0,a.jsx)(i.li,{children:"Ka\u017cdy etap bierze dane z poprzedniego i zmienia je lub filtruje."}),"\n"]}),(0,a.jsx)(i.admonition,{title:"W MongoDB ka\u017cdy taki etap to operator zaczynaj\u0105cy si\u0119 od $:",type:"tip",children:(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$match"})," \u2013 wybiera dokumenty"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$project"})," \u2013 wybiera pola / tworzy nowe pola"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$group"})," \u2013 grupuje i liczy"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$sort"})," \u2013 sortuje"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$limit"})," \u2013 ogranicza wynik"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$count"})," \u2013 liczy dokumenty"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$lookup"})," \u2013 do\u0142\u0105cza dane z innej kolekcji (prawie jak JOIN)"]}),"\n"]})})]}),"\n",(0,a.jsx)(i.h3,{id:"struktura-agregacji",children:"Struktura agregacji"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:"db.collection.aggregate([\n  { etap1 },\n  { etap2 },\n  { etap3 }\n])\n"})}),"\n",(0,a.jsx)(i.h3,{id:"prosty-przyk\u0142ad",children:"Prosty przyk\u0142ad"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:"db.users.aggregate([\n  { $match: { age: { $gt: 18 } } },\n  { $project: { name: 1, age: 1 } }\n])\n"})}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$match"}),"      wybierz pe\u0142noletnich"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$project"}),"    poka\u017c tylko imi\u0119 i wiek"]}),"\n"]}),"\n",(0,a.jsxs)(i.h3,{id:"find-i-aggregate",children:[(0,a.jsx)(i.code,{children:"find()"})," i ",(0,a.jsx)(i.code,{children:"aggregate()"})]}),"\n",(0,a.jsxs)(i.table,{children:[(0,a.jsx)(i.thead,{children:(0,a.jsxs)(i.tr,{children:[(0,a.jsx)(i.th,{children:"find()"}),(0,a.jsx)(i.th,{children:"aggregate()"})]})}),(0,a.jsxs)(i.tbody,{children:[(0,a.jsxs)(i.tr,{children:[(0,a.jsx)(i.td,{children:"Filtruje dokumenty"}),(0,a.jsx)(i.td,{children:"Filtruje i przetwarza dokumenty w etapach"})]}),(0,a.jsxs)(i.tr,{children:[(0,a.jsx)(i.td,{children:"Poka\u017c wybrane pola"}),(0,a.jsx)(i.td,{children:"Tw\xf3rz nowe pola, zmieniaj struktur\u0119"})]}),(0,a.jsxs)(i.tr,{children:[(0,a.jsx)(i.td,{children:"Tylko proste zapytania"}),(0,a.jsx)(i.td,{children:"Statystyki, grupowanie, sortowanie"})]}),(0,a.jsxs)(i.tr,{children:[(0,a.jsx)(i.td,{children:"Nie robi JOIN"}),(0,a.jsxs)(i.td,{children:["Ma ",(0,a.jsx)(i.code,{children:"$lookup"})]})]}),(0,a.jsxs)(i.tr,{children:[(0,a.jsx)(i.td,{children:"Bardzo proste"}),(0,a.jsx)(i.td,{children:"Bardzo pot\u0119\u017cne"})]})]})]}),"\n",(0,a.jsx)(i.h2,{id:"praktyka",children:"Praktyka"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:["tworzymy baz\u0119 ",(0,a.jsx)(i.code,{children:"use foodDB"})]}),"\n",(0,a.jsxs)(i.li,{children:["tworzymy kolekcj\u0119 ",(0,a.jsx)(i.code,{children:'db.createCollection("foods")'})]}),"\n",(0,a.jsxs)(i.li,{children:["wprowadzamy dane przez interfejs ",(0,a.jsx)(i.em,{children:"Compass"})," -> ",(0,a.jsx)(i.code,{children:"Documents"})," > ",(0,a.jsx)(i.code,{children:"+"}),":"]}),"\n"]}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:'/**\n* Paste one or more documents here\n*/\n[\n  { "name": "Apple",      "category": "fruit",  "calories": 52,  "vitamins": ["A", "C"] },\n  { "name": "Banana",     "category": "fruit",  "calories": 96,  "vitamins": ["B6", "C"] },\n  { "name": "Carrot",     "category": "vegetable", "calories": 41, "vitamins": ["A", "K"] },\n  { "name": "Broccoli",   "category": "vegetable", "calories": 55, "vitamins": ["C", "K"] },\n  { "name": "Chicken",    "category": "meat",   "calories": 239, "vitamins": ["B6"] }\n]\n'})}),"\n",(0,a.jsx)(i.h3,{id:"zapytania",children:"Zapytania"}),"\n",(0,a.jsx)(i.h4,{id:"wybierzmy-tylko-warzywa",children:"Wybierzmy tylko warzywa"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:'db.foods.aggregate([\n  {$match: { category: "vegetable"}}\n])\n'})}),"\n",(0,a.jsx)(i.h4,{id:"z-warzyw-wy\u015bwietlmy-tylko-nazw\u0119-i-kaloryczno\u015b\u0107",children:"Z warzyw wy\u015bwietlmy tylko nazw\u0119 i kaloryczno\u015b\u0107"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:'db.foods.aggregate([\n  {$match: { category: "vegetable"}},\n  {$project: {name: 1, calories: 1, _id:0}}\n])\n'})}),"\n",(0,a.jsxs)(i.p,{children:["To samo w ",(0,a.jsx)(i.em,{children:"Compass"}),":"]}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:["wybieramy zak\u0142adk\u0119 ",(0,a.jsx)(i.code,{children:"Aggregations"}),":","\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:["tworzymy nowy ",(0,a.jsx)(i.code,{children:"stage"})," przez naci\u015bni\u0119cie przyciku ",(0,a.jsx)(i.code,{children:"Add stage"})]}),"\n",(0,a.jsxs)(i.li,{children:["w ",(0,a.jsx)(i.code,{children:"Stage 1 <Select> "})," wybieramy ",(0,a.jsx)(i.code,{children:"$match"})," i wpisujemy:","\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:(0,a.jsx)(i.code,{children:'{category: "vegetable"}'})}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(i.li,{children:["w ",(0,a.jsx)(i.code,{children:"Stage 2 <Select> "})," wybieramy ",(0,a.jsx)(i.code,{children:"$project"})," i wpisujemy:","\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:(0,a.jsx)(i.code,{children:"{ name:1, calories: 1, _id:0 }"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(i.h3,{id:"grupujemy-group",children:["Grupujemy ",(0,a.jsx)(i.code,{children:"$group"})]}),"\n",(0,a.jsx)(i.h4,{id:"ile-produk\xf3w-w-danej-kategorii",children:"Ile produk\xf3w w danej kategorii"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:'db.foods.aggregate([{\n $group: {\n  \t_id: "$category",\n    totalFoods: {$sum: 1}\n }\n}])\n'})}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"_id"}),"     pole, po kt\xf3rym grupujemy (tu: kategoria jedzenia)"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$sum: 1"})," dodaj 1 dla ka\u017cdego dokumentu"]}),"\n"]}),"\n",(0,a.jsxs)(i.admonition,{type:"tip",children:[(0,a.jsxs)(i.mdxAdmonitionTitle,{children:["Co to jest ",(0,a.jsx)(i.code,{children:"$category"})]}),(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:'"$category"'})," oznacza: \u201ewe\u017a warto\u015b\u0107 pola ",(0,a.jsx)(i.code,{children:"category"})," z ka\u017cdego dokumentu\u201d"]}),"\n",(0,a.jsxs)(i.li,{children:["Czyli:","\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:["bez ",(0,a.jsx)(i.code,{children:"$"}),' to zwyk\u0142y tekst "category"']}),"\n",(0,a.jsxs)(i.li,{children:["z ",(0,a.jsx)(i.code,{children:"$"})," to odwo\u0142anie do pola w dokumencie"]}),"\n"]}),"\n"]}),"\n"]}),(0,a.jsx)(i.p,{children:"to tak, jaby\u015bmy powiedzieli:\n\u201eGrupuj dokumenty wed\u0142ug tego, co jest zapisane w polu category\u201d."})]}),"\n",(0,a.jsx)(i.h4,{id:"\u015brednia-liczba-kalorii-w-ka\u017cdej-kategorii",children:"\u015arednia liczba kalorii w ka\u017cdej kategorii"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:'db.foods.aggregate([\n  {\n    $group: {\n      _id: "$category",\n      avgCalories: { $avg: "$calories" }\n    }\n  }\n])\n'})}),"\n",(0,a.jsx)(i.h4,{id:"najmniej-i-najbardziej-kaloryczny-produkt-w-kategorii",children:"Najmniej i najbardziej kaloryczny produkt w kategorii"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:'db.foods.aggregate([\n  {\n    $group: {\n      _id: "$category",\n      minCalories: { $min: "$calories" },\n      maxCalories: { $max: "$calories" }\n    }\n  }\n])\n'})}),"\n",(0,a.jsx)(i.h4,{id:"lista-nazw-produkt\xf3w-w-ka\u017cdej-kategorii",children:"Lista nazw produkt\xf3w w ka\u017cdej kategorii"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:'db.foods.aggregate([\n  {\n    $group: {\n      _id: "$category",\n      products: { $push: "$name" }\n        }\n    }\n])\n'})}),"\n",(0,a.jsx)(i.h3,{id:"sortujemy",children:"Sortujemy"}),"\n",(0,a.jsx)(i.h4,{id:"sortowanie-po-kaloriach-malej\u0105co-najbardziej-kaloryczne",children:"Sortowanie po kaloriach malej\u0105co (najbardziej kaloryczne)"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:"db.foods.aggregate([\n  { $sort: { calories: -1 } }\n])\n"})}),"\n",(0,a.jsxs)(i.admonition,{type:"tip",children:[(0,a.jsxs)(i.mdxAdmonitionTitle,{children:["sortowanie ",(0,a.jsx)(i.code,{children:"1"}),", ",(0,a.jsx)(i.code,{children:"-1"})]}),(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"sortowanie w agregacji,"}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"-1"})," = malej\u0105co, ",(0,a.jsx)(i.code,{children:"1 ="})," rosn\u0105co."]}),"\n"]})]}),"\n",(0,a.jsx)(i.h4,{id:"sortowanie-po-kategorii-a-w-ramach-kategorii-po-kaloriach",children:"Sortowanie po kategorii, a w ramach kategorii po kaloriach"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:"db.foods.aggregate([\n  { $sort: { category: 1, calories: -1 } }\n])\n"})}),"\n",(0,a.jsx)(i.h4,{id:"dwa-najbardziej-kaloryczne-produkty",children:"Dwa najbardziej kaloryczne produkty"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:"db.foods.aggregate([\n  { $sort: { calories: -1 } },\n  { $limit: 2 }\n])\n\n"})}),"\n",(0,a.jsxs)(i.h3,{id:"ograniczenia-wynik\xf3w---limit",children:["Ograniczenia wynik\xf3w - ",(0,a.jsx)(i.code,{children:"limit"})]}),"\n",(0,a.jsx)(i.h4,{id:"najbardziej-kaloryczny-produkt-w-ka\u017cdej-kategorii",children:"Najbardziej kaloryczny produkt w ka\u017cdej kategorii"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:'db.foods.aggregate([\n  { $sort: { calories: -1 } },\n  {\n    $group: {\n      _id: "$category",\n      topFood: { $first: "$$ROOT" }\n    }\n  },\n  { $limit: 3 }\n])\n'})}),"\n",(0,a.jsxs)(i.admonition,{title:"Co si\u0119 dzieje krok po kroku?",type:"tip",children:[(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$sort"}),"   dokumenty s\u0105 posortowane od najbardziej kalorycznych"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$group"}),"  MongoDB bierze dokumenty kategoria po kategorii"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$first"}),"  bierze pierwszy dokument w danej grupie"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$$ROOT"}),"  zapisuje ca\u0142y dokument, a nie tylko jedno pole"]}),"\n"]}),(0,a.jsx)(i.p,{children:"Efekt:\nDla ka\u017cdej kategorii dostajesz najbardziej kaloryczny produkt jako pe\u0142ny obiekt."})]}),"\n",(0,a.jsx)(i.p,{children:"Takie same zapytanie, ale w odpowiedzie dostajemy tylko nazw\u0119 produktu"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:'db.foods.aggregate([\n    { $sort: { calories: -1 } },\n    {\n        $group: {\n            _id: "$category",\n            topFood: { $first: "$name" }\n        }\n    },\n    { $limit: 3 }\n])\n\n'})}),"\n",(0,a.jsx)(i.h4,{id:"pierwsze-3-produkty-po-alfabecie-projekcja--limit",children:"Pierwsze 3 produkty po alfabecie (projekcja + limit)"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{children:"db.foods.aggregate([\n  { $sort: { name: 1 } },\n  { $limit: 3 },\n  {\n    $project: {\n      _id: 0,\n      name: 1,\n      category: 1\n    }\n  }\n])\n\n"})}),"\n",(0,a.jsx)(i.admonition,{type:"tip",children:(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$name"}),"   \u201ewe\u017a tylko imi\u0119\u201d"]}),"\n",(0,a.jsxs)(i.li,{children:[(0,a.jsx)(i.code,{children:"$$ROOT"}),"  \u201ezr\xf3b ksero ca\u0142ego dokumentu\u201d"]}),"\n"]})}),"\n",(0,a.jsx)(i.h2,{id:"zliczanie-dokument\xf3w",children:"Zliczanie dokument\xf3w"}),"\n",(0,a.jsxs)(i.p,{children:["Policzenie wszystkich:\n",(0,a.jsx)(i.code,{children:"db.users.countDocuments()"})]}),"\n",(0,a.jsxs)(i.p,{children:["Policzenie z filtrem:\n",(0,a.jsx)(i.code,{children:"db.users.countDocuments({ age: { $gt: 18 } })"})]})]})}function j(e={}){const{wrapper:i}={...(0,o.R)(),...e.components};return i?(0,a.jsx)(i,{...e,children:(0,a.jsx)(s,{...e})}):s(e)}},8453:(e,i,n)=>{n.d(i,{R:()=>d,x:()=>l});var r=n(6540);const a={},o=r.createContext(a);function d(e){const i=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function l(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:d(e.components),r.createElement(o.Provider,{value:i},e.children)}}}]);